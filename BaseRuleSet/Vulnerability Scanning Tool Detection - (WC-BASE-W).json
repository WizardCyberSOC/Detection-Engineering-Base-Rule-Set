{
    "contentVersion":  "1.0.0.0",
    "$schema":  "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "resources":  [
                      {
                          "id":  "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/a2c011a6-3986-411a-9e27-286d018e1b65')]",
                          "name":  "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a2c011a6-3986-411a-9e27-286d018e1b65')]",
                          "type":  "Microsoft.OperationalInsights/workspaces/providers/alertRules",
                          "kind":  "Scheduled",
                          "apiVersion":  "2023-12-01-preview",
                          "properties":  {
                                             "displayName":  "Vulnerability Scanning Tool Detection - [WC-BASE-W]",
                                             "description":  "Adversaries can scan your system with some penetration tools\n",
                                             "severity":  "Medium",
                                             "enabled":  true,
                                             "query":  "let alerttable = \n    union DeviceProcessEvents, DeviceFileEvents, DeviceNetworkEvents\n    | where (InitiatingProcessFileName has 'Nessus'\n        or InitiatingProcessFileName has 'Netsparker'\n        or InitiatingProcessFileName has 'dirbuster'\n        or InitiatingProcessFileName has 'hydra'\n        or InitiatingProcessFileName has 'sqlmap'\n        or InitiatingProcessFileName has 'sqlninja'\n        or InitiatingProcessFileName has 'nmap'\n        or InitiatingProcessFileName has 'zenmap'\n        or InitiatingProcessFileName has 'netsparker'\n        or InitiatingProcessFileName has 'burp*'\n        or InitiatingProcessFileName has 'acunetix*'\n        or InitiatingProcessFileName has 'rapid7'\n        or InitiatingProcessFileName has 'nexpose'\n        or InitiatingProcessFileName has 'openvas'\n        or InitiatingProcessFileName has 'qualys'\n        or InitiatingProcessFileName has 'tenable'\n        or InitiatingProcessFileName has 'tripwire'\n        or InitiatingProcessFileName has 'saint'\n        or InitiatingProcessFileName has 'nikto')\n        or InitiatingProcessFileName has 'gfi*'\n        or InitiatingProcessFileName has 'languard'\n        or InitiatingProcessFileName has 'solarwind*'\n        or InitiatingProcessFileName has 'retina'\n        or InitiatingProcessFileName has 'aircrack*'\n        or InitiatingProcessFileName has 'cwatch'\n        or InitiatingProcessFileName has 'portswigger'\n        or InitiatingProcessFileName has 'sonarqube'\n        or InitiatingProcessFileName has 'vulcan'\n        or InitiatingProcessFileName has 'kali'\n        or InitiatingProcessFileName has 'commando*'\n        or InitiatingProcessFileName has 'shredkit'\n        or InitiatingProcessFileName has 'hashcat'\n        or InitiatingProcessFileName has 'intruder'\n        or InitiatingProcessFileName has 'zmap'\n        or InitiatingProcessFileName has 'xray'\n        or InitiatingProcessFileName has 'fuzzdb'\n        or InitiatingProcessFileName has 'catfish'\n        or InitiatingProcessFileName has 'coreimpact'\n        or InitiatingProcessFileName has 'hackerone'\n        or InitiatingProcessFileName has 'breachlock'\n        or InitiatingProcessFileName has 'w3af'\n        or InitiatingProcessFileName has 'johntheripper'\n        or InitiatingProcessFileName has 'canvas'\n        or InitiatingProcessFileName has 'nexfil'\n        or InitiatingProcessFileName has 'osmedeus'\n        or InitiatingProcessFileName has 'portscan'\n        or InitiatingProcessFileName has '*nessusd.exe*'\n    | where InitiatingProcessAccountName !contains \"root\";\nlet FilterCyberCNS =  DeviceEvents\n    | union DeviceProcessEvents, DeviceNetworkEvents\n    | where FileName contains \"cyberns\"\n        or InitiatingProcessFileName contains \"cybercns\"\n        or InitiatingProcessParentFileName contains \"cybercns\" \n    | distinct DeviceName;\nalerttable\n| join kind=leftanti FilterCyberCNS on DeviceName\n// WHITELIST START\n| extend RuleName = 'Vulnerability Scanning Tool Detection'\n| join kind=leftouter (_GetWatchlist('WizardCyberAnalyticalRulesTuning')\n) on RuleName\n| project-away RuleName,RuleName1\n| extend Tuning01 = todynamic(Tuning01)\n| extend Tuning02 = todynamic(Tuning02)\n| where not(  (TicketIDs contains \"3017819\" and isnotempty(Tuning01)) and Tuning01 contains (DeviceName) )\n| where not(  (TicketIDs contains \"3017813\" and isnotempty(Tuning01)) and Tuning01 has InitiatingProcessFileName )\n| where not(  (TicketIDs contains \"2012230\" and isnotempty(Tuning01)) and InitiatingProcessParentFileName == Tuning01.[0] )\n| where not(  (TicketIDs contains \"1919827\" and isnotempty(Tuning01)) and DeviceName == Tuning01.[0] )\n| where not(  (TicketIDs contains \"3017874\" and isnotempty(Tuning01)) and InitiatingProcessFileName contains Tuning01.[0] )\n| where not(  (TicketIDs contains \"3017899\" and isnotempty(Tuning01)) and Tuning01 has DeviceName)\n| where not(  (TicketIDs contains \"3017899\" and isnotempty(Tuning02)) and (InitiatingProcessFileName contains Tuning02.[0] or InitiatingProcessFileName contains Tuning02.[1]))\n| where not(  (TicketIDs contains \"3017904\" and isnotempty(Tuning01)) and InitiatingProcessFileName contains Tuning01.[0])\n| where not(  (TicketIDs contains \"2627078\" and isnotempty(Tuning01)) and InitiatingProcessFileName contains Tuning01.[0])\n| where not(  (TicketIDs contains \"2434374\" and isnotempty(Tuning01)) and InitiatingProcessFileName contains Tuning01.[0])\n| where not(  (TicketIDs contains \"2925245\" and isnotempty(Tuning01)) and InitiatingProcessFolderPath contains Tuning01.[0] and ActionType in(\"ConnectionSuccess\",\"ConnectionFailed\") and ipv4_is_private( RemoteIP) )\n| project-away Tuning*,TicketIDs\n// WHITELIST END\n\n",
                                             "queryFrequency":  "PT15M",
                                             "queryPeriod":  "PT15M",
                                             "triggerOperator":  "GreaterThan",
                                             "triggerThreshold":  0,
                                             "suppressionDuration":  "PT5H",
                                             "suppressionEnabled":  false,
                                             "startTimeUtc":  null,
                                             "tactics":  [
                                                             "Reconnaissance"
                                                         ],
                                             "techniques":  [
                                                                "T1595"
                                                            ],
                                             "subTechniques":  [

                                                               ],
                                             "alertRuleTemplateName":  null,
                                             "incidentConfiguration":  {
                                                                           "createIncident":  true,
                                                                           "groupingConfiguration":  {
                                                                                                         "enabled":  true,
                                                                                                         "reopenClosedIncident":  false,
                                                                                                         "lookbackDuration":  "PT5H",
                                                                                                         "matchingMethod":  "AllEntities",
                                                                                                         "groupByEntities":  [

                                                                                                                             ],
                                                                                                         "groupByAlertDetails":  [

                                                                                                                                 ],
                                                                                                         "groupByCustomDetails":  [

                                                                                                                                  ]
                                                                                                     }
                                                                       },
                                             "eventGroupingSettings":  {
                                                                           "aggregationKind":  "SingleAlert"
                                                                       },
                                             "alertDetailsOverride":  {
                                                                          "alertDynamicProperties":  [

                                                                                                     ]
                                                                      },
                                             "customDetails":  {

                                                               },
                                             "entityMappings":  [
                                                                    {
                                                                        "entityType":  "Account",
                                                                        "fieldMappings":  [
                                                                                              {
                                                                                                  "identifier":  "FullName",
                                                                                                  "columnName":  "InitiatingProcessAccountName"
                                                                                              },
                                                                                              {
                                                                                                  "identifier":  "DisplayName",
                                                                                                  "columnName":  "DeviceName"
                                                                                              }
                                                                                          ]
                                                                    },
                                                                    {
                                                                        "entityType":  "Process",
                                                                        "fieldMappings":  [
                                                                                              {
                                                                                                  "identifier":  "CommandLine",
                                                                                                  "columnName":  "InitiatingProcessFileName"
                                                                                              }
                                                                                          ]
                                                                    },
                                                                    {
                                                                        "entityType":  "Host",
                                                                        "fieldMappings":  [
                                                                                              {
                                                                                                  "identifier":  "HostName",
                                                                                                  "columnName":  "DeviceName"
                                                                                              }
                                                                                          ]
                                                                    }
                                                                ],
                                             "sentinelEntitiesMappings":  null,
                                             "templateVersion":  null
                                         }
                      }
                  ],
    "parameters":  {
                       "workspace":  {
                                         "type":  "String"
                                     }
                   }
}